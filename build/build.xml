<?xml version="1.0"?>
<!-- ====================================================================== 
Build a new distribution of Ortus CommandBox
====================================================================== -->
<project name="distro.build" default="build" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">
	 <description>
    	Build a new distribution of Ortus CommandBox
    </description>

    <!-- Build Labels -->
	<tstamp prefix="start"/>
	<!-- Default environment check, if not passed via -Denvironment -->
	<condition property="environment" value="local">
		<not><isset property="environment" /></not>
	</condition>
	<echo>Loading Properties from environment: ${environment}</echo>
	<!-- Load env properties -->
	<loadproperties srcFile="build-${environment}.properties"/>

	<!-- import cfdistro -->
	<import file="${cfdistro.build.file}"/>
	<!-- import cli -->
	<import file="build-cli.xml"/>
	<property name="maven.repo.local" value="${cfdistro.basedir}/artifacts"/>

	<!-- Default Target -->
	<target name="build" depends="build.cli">
	</target>

	<!-- ********************************************************************************************-->
	<!--						TEST TARGETS 														 -->
	<!-- ********************************************************************************************-->

	<target name="build.testwar" depends="cfdistro.build" description="creates test war">
		<!-- creates a war for testing in dist/, use 'box-cli runwar.start.fg' to run -->
		<dependency artifactId="testbox" groupId="org.coldbox" version="1.1.0" mapping="/testbox" />
		<!-- set mapping for MXUnit compat -->
		<mapping physical="@ext.mappings.dir@/org.coldbox/testbox/1.1.0/system/testing/compat" virtual="/mxunit"/>
		<!-- set mappings for sources, tests -->
		<mapping virtual="/commandbox" physical="@src.dir@/cfml" />
		<mapping virtual="/wirebox" physical="@src.dir@/cfml/system/wirebox" />
		<mapping virtual="/cfml" physical="@src.dir@/cfml" />
		<mapping virtual="/tests" physical="@src.dir@/../tests" />
	</target>

	<target name="test" description="starts test server, runs tests, then stops test server">
		<server-run>
			<testbox-rundirs basePath="${tests.dir}/cfml" componentPath="tests.cfml" outputdir="${dist.dir}/testresults/"  
			runner="http://${runwar.host}:${runwar.port}/tests/tboxrunner.cfm?"/>
		</server-run>
	</target>

	<target name="build.test" depends="build.testwar,test" description="build test war, run tests">
		<!-- mostly for automated builds- you really only need to build the testwar once -->
	</target>

	<target name="build.test.all" depends="build.test,build.cli.all">
	</target>

</project>
